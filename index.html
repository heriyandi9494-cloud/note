<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pengeluaran Harian</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ===== GLOBAL ===== */
body { background:#f5f6f8; }
.card { border-radius:14px; }
.card h6 { font-weight:600; letter-spacing:1px; }
.card h3, .card h4 { font-weight:bold; }

/* ===== TABLE ===== */
.table-responsive {
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
}
td, th {
    white-space:nowrap;
    font-size:14px;
    vertical-align:middle;
}
.table th, .table td {
    border:1px solid #222 !important;
}

/* ===== BUTTON ===== */
.btn-sm {
    padding:4px 8px;
    font-size:12px;
}

/* ===== MOBILE ===== */
@media (max-width:576px){
    .card h3 { font-size:1.4rem; }
    .card h4 { font-size:1.2rem; }
}
</style>
</head>

<body>

<div class="container-fluid px-2 px-md-4 my-4">

<!-- SALDO -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card text-bg-warning">
            <div class="card-body">
                <h6>SISA SALDO</h6>
                <h3 id="saldo">Rell 0</h3>
            </div>
        </div>
    </div>
</div>

<!-- CARD -->
<div class="row g-2 g-md-3">
    <div class="col-md-6">
        <div class="card text-bg-primary">
            <div class="card-body">
                <h6>PENGELUARAN HARIAN</h6>
                <h3 id="harian">Rell 0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-bg-success">
            <div class="card-body">
                <h6>TOTAL PENGELUARAN</h6>
                <h3 id="total">Rell 0</h3>
            </div>
        </div>
    </div>
</div>

<div class="row g-2 g-md-3 mt-3">
    <div class="col-md-4">
        <div class="card text-bg-secondary">
            <div class="card-body">
                <h6>Total Rell</h6>
                <h4 id="totalRell">Rell 0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-bg-info">
            <div class="card-body">
                <h6>Total Dolar</h6>
                <h4 id="totalUSD">$ 0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-bg-danger">
            <div class="card-body">
                <h6>Total Rupiah</h6>
                <h4 id="totalRupiah">Rp 0</h4>
            </div>
        </div>
    </div>
</div>

<!-- BUTTON -->
<div class="d-grid my-3">
    <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalTambah">
        + TAMBAH PENGELUARAN
    </button>
</div>

<!-- SALDO INPUT -->
<div class="card my-3">
    <div class="card-body">
        <label class="fw-bold mb-2">Tambahkan Saldo</label>
        <div class="input-group">
            <input type="number" id="saldoAwalInput" class="form-control" placeholder="Masukkan saldo">
            <button class="btn btn-success" onclick="simpanSaldo()">Simpan</button>
        </div>
    </div>
</div>

<!-- FILTER -->
<div class="card my-3">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-8">
                <input type="date" id="inputTanggal" class="form-control">
            </div>
            <div class="col-4 d-grid">
                <button class="btn btn-warning" onclick="filterTanggal()">Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- TABLE -->
<div class="table-responsive rounded shadow-sm">
<table class="table table-sm table-striped table-bordered text-center">
    <thead class="table-dark">
        <tr>
            <th>Tanggal</th>
            <th>Keterangan</th>
            <th>Rell</th>
            <th>$</th>
            <th>Rp</th>
            <th>âœ“</th>
            <th>Aksi</th>
        </tr>
    </thead>
    <tbody id="tabelData"></tbody>
</table>
</div>

</div>

<!-- MODAL TAMBAH -->
<div class="modal fade" id="modalTambah">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
    <div class="modal-header">
        <h5>Tambah Pengeluaran</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <input type="date" id="tanggal" class="form-control mb-2">
        <input type="text" id="keterangan" class="form-control mb-2" placeholder="Keterangan">
        <input type="number" id="nominal" class="form-control mb-2" placeholder="Nominal">
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" onclick="simpanData()">Simpan</button>
    </div>
</div>
</div>
</div>

<!-- MODAL FILTER -->
<div class="modal fade" id="modalFilter">
<div class="modal-dialog modal-lg modal-dialog-centered">
<div class="modal-content">
    <div class="modal-header">
        <h5>Hasil Filter</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Nominal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelFilter"></tbody>
            </table>
        </div>
        <div class="fw-bold text-end">
            Total: <span id="totalFilter">Rell 0</span>
        </div>
    </div>
</div>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyAtQ1z2lncUe28cNG0nISDlJUa_wvQs8Aw",
  authDomain: "jamtidur-c9cde.firebaseapp.com",
  databaseURL: "https://jamtidur-c9cde-default-rtdb.firebaseio.com",
  projectId: "jamtidur-c9cde"
});

const db = firebase.database();
let saldoAwal = 0;

/* ===== SALDO ===== */
db.ref("saldo").on("value", s=>{
    saldoAwal = s.val() || 0;
    hitungSaldo();
});

function simpanSaldo(){
    const val = parseInt(saldoAwalInput.value);
    if(!val || val<=0) return alert("Saldo tidak valid");
    db.ref("saldo").set(saldoAwal + val);
    saldoAwalInput.value="";
}

/* ===== DATA ===== */
function simpanData(){
    db.ref("pengeluaran").push({
        tanggal:tanggal.value,
        keterangan:keterangan.value,
        nominal:parseInt(nominal.value),
        cek:false
    });
    bootstrap.Modal.getInstance(modalTambah).hide();
}

db.ref("pengeluaran").on("value", snap=>{
    tabelData.innerHTML="";
    let total=0, harian=0, usd=0, rupiah=0;

    snap.forEach(i=>{
        const d=i.val(), id=i.key;
        const u=d.nominal/4000, r=u*17000;
        usd+=u; rupiah+=r;

        d.cek ? total+=d.nominal : harian+=d.nominal;

        tabelData.innerHTML+=`
        <tr>
            <td>${d.tanggal}</td>
            <td>${d.keterangan}</td>
            <td>Rell ${d.nominal.toLocaleString()}</td>
            <td>$ ${u.toFixed(2)}</td>
            <td>Rp ${r.toLocaleString()}</td>
            <td><input type="checkbox" ${d.cek?"checked":""}
                onchange="db.ref('pengeluaran/${id}').update({cek:this.checked})"></td>
            <td><button class="btn btn-danger btn-sm"
                onclick="hapusData('${id}')">Hapus</button></td>
        </tr>`;
    });

    totalEl(total,harian,usd,rupiah);
});

/* ===== FILTER TANGGAL ===== */
function filterTanggal() {
    const tanggalDipilih = document.getElementById("inputTanggal").value;

    if (!tanggalDipilih) {
        alert("Silakan pilih tanggal");
        return;
    }

    const tabelFilter = document.getElementById("tabelFilter");
    const totalFilter = document.getElementById("totalFilter");

    tabelFilter.innerHTML = "";
    let total = 0;

    db.ref("pengeluaran").once("value", snapshot => {
        snapshot.forEach(item => {
            const d = item.val();

            if (d.tanggal === tanggalDipilih) {
                total += d.nominal;

                tabelFilter.innerHTML += `
                <tr>
                    <td>${d.tanggal}</td>
                    <td>${d.keterangan}</td>
                    <td>Rell ${d.nominal.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                            onclick="hapusData('${item.key}')">
                            Hapus
                        </button>
                    </td>
                </tr>`;
            }
        });

        totalFilter.innerText = "Rell " + total.toLocaleString();

        // ðŸ”¥ PAKSA MODAL MUNCUL
        const modal = new bootstrap.Modal(
            document.getElementById("modalFilter")
        );
        modal.show();
    });
}


/* ===== UTIL ===== */
function hapusData(id){
    if(confirm("Hapus data?")) db.ref("pengeluaran/"+id).remove();
}
function hitungSaldo(p=0){
    saldo.innerText="Rell "+(saldoAwal-p).toLocaleString();
}
function totalEl(t,h,u,r){
    total.innerText="Rell "+t.toLocaleString();
    harian.innerText="Rell "+h.toLocaleString();
    totalRell.innerText="Rell "+t.toLocaleString();
    totalUSD.innerText="$ "+u.toFixed(2);
    totalRupiah.innerText="Rp "+r.toLocaleString();
    hitungSaldo(t);
}
</script>
</body>
</html>
